<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CodePen - floating website chat button (intercom inspired)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css'>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./memberchat/style.css">


    <!--    </style> -->
</head>

<body>
    <!-- partial:index.partial.html -->
    <div class="floating-chat">
        <i class="fa fa-comments" aria-hidden="true"></i>
        <div class="chat">
            <div class="header">
                <span class="title"></span>
                <span id="usernameSp" class="title">客服人員</span>
                <button>
                    <i class="fa fa-times" aria-hidden="true"></i>
                </button>

            </div>

            <ul id="messagesUl" class="messages">
                <!--  			<li class="other"></li> -->
                <!--             <li class="other">您好很高興為您服務</li> -->
                <!--             <p class="d-block text-truncate text-success fs-6 mb-0">Available</p> -->
                <!--             <li class="other">請問還有什麼問題需要協助的嗎?</li> -->
                <!--             <li class="self">我購買一個產品，因為不符合需求，我想要退貨</li> -->
                <!--             <li class="other">好的，請問訂單編號是多少呢?</li> -->
                <!--             <li class="self">Order13579</li> -->
                <!--             <li class="other">請問購買的商品為:Nike籃球，售價:$500 對嗎?</li> -->
                <!--             <li class="self">是的</li> -->
                <!--             <li class="other">已幫你辦好退貨處理，麻煩在七天內，退還商品到我們官網上提供的退貨地點 </li> -->
                <!--             <li class="self">好，謝謝</li> -->
            </ul>
            <div class="footer">
                <span></span>
                <div id="messageDiv" class="text-box" contenteditable="true" disabled="true"></div>
                <button id="sendMessage">send</button>
            </div>
        </div>
    </div>
    <!-- partial -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
    <script src="./script.js"></script>

    <script>
        const messagesUl = document.querySelector('#messagesUl');

        const username = sessionStorage.getItem("MyKeyName");

        const webSocket = new WebSocket(getUri());

        webSocket.addEventListener('open', e => {
            console.log('連線成功');
        });

        webSocket.addEventListener('message', e => {
            const obj = JSON.parse(e.data);
            messagesUl.innerHTML += `<li class="other"><div>${obj.content}</div></li>`;
            messagesUl.scrollTo(0, messagesUl.scrollHeight);
        });

        webSocket.addEventListener('close', e => {
            console.log('連線失敗');
        });

        function getCurrentTimeZoneFormat() {
            return new Date().toLocaleString("en-US", {
                hour: "numeric",
                minute: "numeric",
                hour12: true,
            });
        }

        function getUri() {
            const endPoint = `/ChatEndpoint/${username}`;
            const { host, pathname } = location;
            const webCtx = pathname.substring(0, pathname.indexOf('/', 1));
            return "ws://" + host + webCtx + endPoint;
        }

        document.querySelector('#sendMessage').addEventListener('click', () => {
            webSocket.send(JSON.stringify({
                type: 'MESSAGE',
                content: messageDiv.textContent
            }));
        });
    </script>
</body>

</html>